<script>
  const WEBHOOK_URL = 'https://abuelomatias.app.n8n.cloud/webhook/deeper-room';

  const VOICES = {
    sofia: 'KODfcDcuOf5M4axjGlMx',
    socrates: 'ki6kmf0TLJkBQr3Vt9dt',
    viajero: 'ML5mQsk0B3e4gEH6KBKz'
  };

  let nombreUsuario = '';
  let destinoActual = '';
  let esperandoRespuesta = false;
  let vozActiva = true;
  let audioActual = null;

  // ✅ una sesión por destino (evita mezcla)
  let sesionIds = { socrates: null, viajero: null };

  // ✅ id estable del usuario en ESTE navegador (para que el backend pueda separar por persona)
  const clientUserId = localStorage.getItem('tdr_user_id') || (() => {
    const id = (crypto?.randomUUID?.() || String(Date.now()) + Math.random());
    localStorage.setItem('tdr_user_id', id);
    return id;
  })();

  async function elegirDestino(destino) {
    destinoActual = destino;

    // ... (tu UI igual)

    document.getElementById('chatMensajes').innerHTML = '';
    agregarMensajeLoading();

    try {
      let body = {
        destino,
        nombre: nombreUsuario,
        mensaje: 'Hola, acabo de entrar',
        user_id: clientUserId,           // ✅ nuevo
      };

      if (destino === 'socrates') body.accion = 'libre';

      // ✅ usa sesión correcta por destino
      if (sesionIds[destino]) body.sesion_id = sesionIds[destino];

      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await response.json();

      // ✅ guarda sesión del destino correcto
      if (data.sesion_id) sesionIds[destino] = data.sesion_id;

      const respuestaTexto = data.respuesta || 'Bienvenido.';

      quitarMensajeLoading();
      agregarMensajePersonaje(respuestaTexto);

      hablar(respuestaTexto.replace(/\[...\]/g, ''), destino === 'socrates' ? 'socrates' : 'viajero');

    } catch (e) {
      quitarMensajeLoading();
      agregarMensajePersonaje('Disculpe, hubo un problema de conexión.');
    }
  }

  async function enviarMensaje() {
    const input = document.getElementById('chatInput');
    const mensaje = input.value.trim();
    if (!mensaje || esperandoRespuesta) return;

    esperandoRespuesta = true;
    document.getElementById('btnEnviar').disabled = true;

    agregarMensajeUsuario(mensaje);
    input.value = '';
    agregarMensajeLoading();

    try {
      const body = {
        destino: destinoActual,
        nombre: nombreUsuario,
        mensaje,
        user_id: clientUserId,                 // ✅ nuevo
      };

      if (destinoActual === 'socrates') body.accion = 'libre';

      // ✅ sesión por destino
      if (sesionIds[destinoActual]) body.sesion_id = sesionIds[destinoActual];

      const response = await fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await response.json();

      // ✅ refresca sesión por destino
      if (data.sesion_id) sesionIds[destinoActual] = data.sesion_id;

      const respuestaTexto = data.respuesta || 'Disculpe, no pude procesar su mensaje.';
      quitarMensajeLoading();
      agregarMensajePersonaje(respuestaTexto);

      hablar(respuestaTexto.replace(/\[...\]/g, ''), destinoActual === 'socrates' ? 'socrates' : 'viajero');

    } catch (e) {
      quitarMensajeLoading();
      agregarMensajePersonaje('Disculpe, hubo un problema de conexión.');
    }

    esperandoRespuesta = false;
    document.getElementById('btnEnviar').disabled = false;
    input.focus();
  }

  function volverAlLobby() {
    if (audioActual) { audioActual.pause(); audioActual = null; }
    chat.style.display = 'none';
    lobby.style.display = 'block';
    btnVolver.classList.add('hidden');
    // ✅ NO resetees sesionIds acá, así si vuelve al mismo personaje mantiene continuidad
  }
</script>
